@page "/freeagency"
@using NBALigaSimulation.Client.Utilities
@using NBALigaSimulation.Shared.Dtos.FA
@inject IPlayerService PlayerService
@inject IFAService FAService
@inject ILocalStorageService LocalStorage
@inject AuthenticationStateProvider AuthStateProvider

<div class="fa-page container py-4">
    <div class="fa-header mb-4">
        <h1 class="h3 mb-1"><i class="bi bi-person-plus me-2"></i>Free Agents</h1>
        <p class="text-muted mb-0">Jogadores disponíveis para contratação</p>
    </div>

    @if (_isLoggedIn)
    {
        <div class="card mb-4 offers-card">
            <div class="card-header offers-card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-send me-2"></i>Minhas ofertas</span>
            </div>
            <div class="card-body p-0">
                @if (_myOffers != null && _myOffers.Count > 0)
                {
                    <div class="table-responsive">
                        <table class="table table-sm mb-0 offers-table">
                            <thead>
                                <tr>
                                    <th class="col-player">Jogador</th>
                                    <th class="col-value">Valor/ano</th>
                                    <th class="col-years">Anos</th>
                                    <th class="col-status">Status</th>
                                    <th class="col-actions"></th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var offer in _myOffers)
                                {
                                    var offerId = offer.Id;
                                    <tr>
                                        <td class="col-player"><a href="@($"players/{offer.PlayerId}")" class="offers-player-link">@offer.PlayerName</a></td>
                                        <td class="col-value text-end">@FormatMoney(offer.Amount)</td>
                                        <td class="col-years text-center">@offer.Years</td>
                                        <td class="col-status">
                                            @if (offer.Response == null)
                                            { <span class="badge offers-badge offers-badge-pending">Pendente</span> }
                                            else if (offer.Response == true)
                                            { <span class="badge offers-badge offers-badge-accepted">Aceita</span> }
                                            else
                                            { <span class="badge offers-badge offers-badge-declined">Recusada</span> }
                                        </td>
                                        <td class="col-actions text-end">
                                            @if (offer.Response == null)
                                            {
                                                <button type="button" class="btn btn-outline-danger btn-sm offers-btn-remove" @onclick="@(async () => await RemoveOffer(offerId))" disabled="@(_removingOfferId == offerId)" title="Excluir oferta">
                                                    @if (_removingOfferId == offerId) { <span class="spinner-border spinner-border-sm"></span> } else { <i class="bi bi-trash"></i> }
                                                </button>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <p class="text-muted mb-0 p-4 text-center">Nenhuma oferta enviada.</p>
                }
            </div>
        </div>
    }

    <div class="fa-filters mb-3">
        <select class="form-select fa-filter-select" @onchange="HandlePositionChange">
            <option value="">Todas as posições</option>
            @foreach (string pos in positions)
            {
                <option value="@pos">@pos</option>
            }
        </select>
        <select class="form-select fa-filter-select" @onchange="HandleSizeChange">
            <option value="">Limite da lista</option>
            @foreach (var item in limit)
            {
                <option value="@item">@item</option>
            }
        </select>
    </div>

    @if (_faPlayers != null)
    {
        <div class="fa-table-container">
            <div class="table-responsive">
                <table class="table fa-table">
                    <thead>
                        <tr>
                            <th class="col-player">JOGADOR</th>
                            <th>AGE</th>
                            <th>EXP</th>
                            <th @onclick='() => SortTable("OVR")'>OVR <i class="bi @GetSortIcon("OVR")"></i></th>
                            <th @onclick='() => SortTable("POT")'>POT <i class="bi @GetSortIcon("POT")"></i></th>
                            <th @onclick='() => SortTable("HGT")'>HGT <i class="bi @GetSortIcon("HGT")"></i></th>
                            <th @onclick='() => SortTable("STR")'>STR <i class="bi @GetSortIcon("STR")"></i></th>
                            <th @onclick='() => SortTable("SPD")'>SPD <i class="bi @GetSortIcon("SPD")"></i></th>
                            <th @onclick='() => SortTable("JMP")'>JMP <i class="bi @GetSortIcon("JMP")"></i></th>
                            <th @onclick='() => SortTable("END")'>END <i class="bi @GetSortIcon("END")"></i></th>
                            <th @onclick='() => SortTable("INS")'>INS <i class="bi @GetSortIcon("INS")"></i></th>
                            <th @onclick='() => SortTable("DNK")'>DNK <i class="bi @GetSortIcon("DNK")"></i></th>
                            <th @onclick='() => SortTable("FT")'>FT <i class="bi @GetSortIcon("FT")"></i></th>
                            <th @onclick='() => SortTable("2PT")'>2PT <i class="bi @GetSortIcon("2PT")"></i></th>
                            <th @onclick='() => SortTable("3PT")'>3PT <i class="bi @GetSortIcon("3PT")"></i></th>
                            <th @onclick='() => SortTable("OIQ")'>OIQ <i class="bi @GetSortIcon("OIQ")"></i></th>
                            <th @onclick='() => SortTable("DIQ")'>DIQ <i class="bi @GetSortIcon("DIQ")"></i></th>
                            <th @onclick='() => SortTable("DRB")'>DRB <i class="bi @GetSortIcon("DRB")"></i></th>
                            <th @onclick='() => SortTable("PSS")'>PSS <i class="bi @GetSortIcon("PSS")"></i></th>
                            <th @onclick='() => SortTable("REB")'>REB <i class="bi @GetSortIcon("REB")"></i></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var player in _faPlayers)
                        {
                            @if (player.Ratings != null)
                            {
                                <tr>
                                    <td class="col-player">
                                        <div class="fa-player-cell">
                                            @if (_isLoggedIn)
                                            {
                                                <a href="@("faoffer/" + player.Id)" class="fa-offer-link" title="Fazer oferta"><i class="bi bi-person-add"></i></a>
                                            }
                                            <img src="@(string.IsNullOrEmpty(player.ImgUrl) ? "Images/Utils/blank.png" : player.ImgUrl)" alt="" class="fa-player-thumb" />
                                            <a href="@($"players/{player.Id}")" class="fa-player-name">@player.Name</a>
                                            <span class="fa-player-pos">@player.Pos</span>
                                        </div>
                                    </td>
                                    <td>@Util.Age(@player.Ratings.LastOrDefault().Season, player.Born.Year)</td>
                                    <td>@player.Ratings.Count</td>
                                    <td><span class="badge @Util.GetBadgeClass(player.Ratings.LastOrDefault()?.CalculateOvr ?? 0)">@(player.Ratings.LastOrDefault()?.CalculateOvr)</span></td>
                                    <td><span class="badge @Util.GetBadgeClass(player.Ratings.LastOrDefault()?.Pot ?? 0)">@(player.Ratings.LastOrDefault()?.Pot)</span></td>
                                    <td>@player.Ratings.LastOrDefault()?.Hgt</td>
                                    <td>@player.Ratings.LastOrDefault()?.Stre</td>
                                    <td>@player.Ratings.LastOrDefault()?.Spd</td>
                                    <td>@player.Ratings.LastOrDefault()?.Jmp</td>
                                    <td>@player.Ratings.LastOrDefault()?.Endu</td>
                                    <td>@player.Ratings.LastOrDefault()?.Ins</td>
                                    <td>@player.Ratings.LastOrDefault()?.Dnk</td>
                                    <td>@player.Ratings.LastOrDefault()?.Ft</td>
                                    <td>@player.Ratings.LastOrDefault()?.Fg</td>
                                    <td>@player.Ratings.LastOrDefault()?.Tp</td>
                                    <td>@player.Ratings.LastOrDefault()?.Oiq</td>
                                    <td>@player.Ratings.LastOrDefault()?.Diq</td>
                                    <td>@player.Ratings.LastOrDefault()?.Drb</td>
                                    <td>@player.Ratings.LastOrDefault()?.Pss</td>
                                    <td>@player.Ratings.LastOrDefault()?.Reb</td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
    else
    {
        <div class="fa-empty alert alert-secondary">
            <i class="bi bi-people me-2"></i>Nenhum free agent disponível.
        </div>
    }
</div>
