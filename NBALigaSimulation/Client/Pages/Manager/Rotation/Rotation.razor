@page "/teams/rotation"
@using NBALigaSimulation.Client.Utilities
@attribute [Authorize]
@inject IAuthService AuthService
@inject ITeamService TeamService
@inject IPlayerService PlayerService
@inject NavigationManager NavigationManager
@inject ILocalStorageService LocalStorage
@inject IJSRuntime JSRuntime;

@if (_team != null)
{
<CascadingAuthenticationState>
  <AuthorizeView>
    <div class="rotation-page container py-4">
      <div class="rotation-header mb-4">
        <div class="d-flex align-items-center gap-3">
          <img src="@($"../Images/Logos/{_team.Abrv}.svg")" alt="@_team.Name" class="rotation-team-logo" />
          <div>
            <h1 class="h3 mb-1">@_team.Name</h1>
            <p class="text-muted mb-0">Rotação e Controle de Minutos</p>
          </div>
        </div>
      </div>

      <div class="rotation-table-container">
        <div class="table-responsive">
          <table class="table rotation-table">
            <thead>
            <tr>
              <th class="col-name">
                <div class="d-flex align-items-center gap-2">
                  <span>JOGADOR</span>
                  <i class="bi bi-question-circle text-muted" style="cursor: help; font-size: 0.9rem;" data-bs-toggle="modal" data-bs-target="#sub"></i>
                </div>
              </th>
              <th>POS</th>
              <th>IDADE</th>
              <th>OVR</th>
              <th>POT</th>
              <th>CONTRATO</th>
              <th>J</th>
              <th>MIN</th>
              <th>PTS</th>
              <th>REB</th>
              <th>AST</th>
              <th>TS%</th>
              <th>
                <div class="d-flex align-items-center gap-2">
                  <span>MIN</span>
                  <i class="bi bi-question-circle text-muted" style="cursor: help; font-size: 0.9rem;" data-bs-toggle="modal" data-bs-target="#rotation"></i>
                </div>
              </th>
            </tr>
            </thead>
            <tbody>
            @foreach (var player in _players.OrderBy(p => p.RosterOrder))
            {
              var playerIndex = _players.OrderBy(p => p.RosterOrder).ToList().IndexOf(player);
              var isStarter = playerIndex < 5;
              var isSelected = player1Selected?.Id == player.Id || player2Selected?.Id == player.Id;
              
              <tr class="@(isSelected ? "row-selected" : "") @(isStarter ? "row-starter" : "row-bench")">
                <td class="col-name">
                  <div class="d-flex align-items-center gap-2">
                    <button class="btn-roster @(isStarter ? "btn-starter" : "btn-bench") @(isSelected ? "btn-selected" : "")" 
                            @onclick="(e) => ChangeRosterOrder(player)"
                            title="@(isStarter ? "Titular" : "Reserva")">
                      @(isStarter ? "TIT" : "RES")
                    </button>
                    <a href="@($"players/{player.Id}")" class="player-name-link">@Util.NomeAbvr(player.Name)</a>
                    @if (!string.IsNullOrEmpty(player.InjuryType) && (player.InjuryGamesRemaining ?? 0) > 0)
                    {
                      <span class="injury-badge-inline ms-1" title="@player.InjuryType">
                        <i class="bi bi-bandaid-fill text-danger small"></i>
                        <span class="small">@(player.InjuryGamesRemaining) J</span>
                      </span>
                    }
                  </div>
                </td>
                <td><span class="badge badge-pos">@player.Pos</span></td>
                <td>@Util.Age(_season, player.Born.Year)</td>
                <td>
                  @if (player.Ratings?.LastOrDefault() != null)
                  {
                    <span class="badge @Util.GetBadgeClass(player.Ratings.LastOrDefault().CalculateOvr)">@player.Ratings.LastOrDefault().CalculateOvr</span>
                  }
                  else
                  {
                    <span class="text-muted">—</span>
                  }
                </td>
                <td>
                  @if (player.Ratings?.LastOrDefault() != null)
                  {
                    <span class="badge @Util.GetBadgeClass(player.Ratings.LastOrDefault().Pot)">@player.Ratings.LastOrDefault().Pot</span>
                  }
                  else
                  {
                    <span class="text-muted">—</span>
                  }
                </td>
                <td class="contract-cell">
                  @if (player.Contract != null)
                  {
                    <span class="contract-text">$@FormatContractAmount(player.Contract.Amount)</span>
                    <span class="contract-exp">até @player.Contract.Exp</span>
                  }
                  else
                  {
                    <span class="text-muted">—</span>
                  }
                </td>
                <td>@(player.RegularStats?.LastOrDefault()?.Games.ToString() ?? "—")</td>
                <td>@(player.RegularStats?.LastOrDefault()?.MinPG ?? "—")</td>
                <td>@(player.RegularStats?.LastOrDefault()?.PtsPG ?? "—")</td>
                <td>@(player.RegularStats?.LastOrDefault()?.TRebPG ?? "—")</td>
                <td>@(player.RegularStats?.LastOrDefault()?.AstPG ?? "—")</td>
                <td>@(player.RegularStats?.LastOrDefault()?.TrueShooting ?? "—")</td>
                <td>
                  <select class="form-select form-select-sm pt-select" 
                          style="background: @Util.GetPtBackground(player.PtModifier); min-width: 60px;" 
                          bind="@player.PtModifier" 
                          @onchange="@(e => UpdatePtModifier(e.Value, player.Id))">
                    <option selected hidden>@GetOptionLabel(@player.PtModifier)</option>
                    @foreach (var pt in PtOptions)
                    {
                      <option value="@pt">@GetOptionLabel(pt)</option>
                    }
                  </select>
                </td>
              </tr>
              @if (playerIndex == 4)
              {
                <tr class="row-divider">
                  <td colspan="13"></td>
                </tr>
              }
            }
            </tbody>
          </table>
        </div>
      </div>
    </div>


    <div class="modal fade" id="rotation" tabindex="-1" aria-labelledby="rotation" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="exampleModalLabel">Controle de minutos</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>
              O jogo dividirá o tempo de jogo com base na habilidade e (endurance).
              Se você quiser influenciar o julgamento dele, suas opções são:</p>
            <p style="background: red; color: white">0 Sem tempo de jogo</p>
            <p style="background: yellow; color: black">- Menos tempo de jogo</p>
            <p style="background: grey; color: black">&nbsp; &nbsp; Deixe o jogo decidir</p>
            <p style="background: blue; color: white">+ Mais tempo de jogo</p>
            <p style="background: greenyellow; color: black">++ Muito Mais tempo de jogo</p>
            <p style="background: green; color: white">+++ Jogará o máximo que o jogador aguentar (Endurance)</p>
          </div>
     
        </div>
      </div>
    </div>

    <div class="modal fade" id="sub" tabindex="-1" aria-labelledby="sub" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="exampleModalLabel">Substituição de jogadores</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>
              Clique no ícone à esquerda para selecionar o jogador que deseja substituir
              Em seguida clique no mesmo ícone do jogador que deseja levar ao time titular
            </p>
          </div>

        </div>
      </div>
    </div>
    
  </AuthorizeView>
</CascadingAuthenticationState>

}